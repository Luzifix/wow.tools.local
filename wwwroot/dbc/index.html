<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <title>WoW.tools</title>
    <meta property='og:type' content='website'>
    <meta property='og:site_name' content='WoW.tools'>
    <meta property='og:title' content='WoW.tools'>
    <meta property='og:image' content='/img/cogw.png'>
    <meta property='twitter:image' content='/img/cogw.png'>
    <meta property='twitter:card' content='summary'>
    <meta property='twitter:site' content='@Marlamin'>
    <meta name='application-name' content='WoW.tools'>
    <meta name='apple-mobile-web-app-title' content='WoW.tools'>
    <meta name='theme-color' content='#343a40'>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon" type="image/png" href="/img/cogw.png" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="/css/font-awesome.min.css" />

    <!-- JQuery -->
    <script src="/js/jquery.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/bootstrap.bundle.min.js"></script>

    <!-- Datatables -->
    <link rel="stylesheet" type="text/css" href="/css/datatables.min.css" />
    <script type="text/javascript" src="/js/datatables.min.js"></script>
    <script src="/js/input.js" crossorigin="anonymous"></script>

    <link href="/css/style.css?v=1661289414" rel="stylesheet">
    <script type="text/javascript" src="/js/main.js"></script>
    <script type="text/javascript" src="/js/tooltips.js"></script>
    <script type="text/javascript" src="/js/anims.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg" id="navbar"></nav>
    <link href="/css/dbc.css" rel="stylesheet">
    <div class="container-fluid">
        <form id='dbcform' action='/dbc/' method='GET'>
            <select id='fileFilter' class='form-control form-control-sm'></select>
            <select id='buildFilter' name='build' class='form-control form-control-sm buildFilter'></select>
            <select id='localeSelection' name='locale' class='form-control form-control-sm buildFilter'></select>
            <div class='btn-group'>
                <a href='' id='downloadCSVButton' class='form-control form-control-sm btn btn-sm btn-secondary disabled'><i class='fa fa-download'></i> CSV</a>
                <button type="button" class="btn btn-sm btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu" style="width: 500px">
                    &nbsp;<a href="" id='downloadDB2Link'><i class='fa fa-download'></i> Download DB2 file</a><br />
                    &nbsp;<a href="" id='downloadallCSVLink'><i class='fa fa-download'></i> Download ZIP of all DB2s as CSV for this build (will take a bit)</a>
                </div>
            </div>
            <label class="btn btn-sm btn-info active">
                <input type="checkbox" autocomplete="off" id="hotfixToggle"> Use hotfixes?
            </label>
            <a style='vertical-align: top;' class='btn btn-secondary btn-sm' data-bs-toggle='modal' href=''
               data-bs-target='#settingsModal'><i class='fa fa-gear'></i> Settings</a>
            <a id='dbdButton' style='vertical-align: top; display: none;' class='btn btn-secondary btn-sm disabled' href=''
               target='_BLANK'><i class='fa fa-external-link'></i> DBD</a>
            <a style='vertical-align: top; display: none' id='fkSearchButton' class='btn btn-secondary btn-sm'
               data-bs-toggle='modal' href='' data-bs-target='#foreignKeySearchModal'><i class='fa fa-search'></i> FK Search</a>
            <a style='vertical-align: top;' id='globalSearchButton' class='btn btn-secondary btn-sm'
               data-bs-toggle='modal' href='' data-bs-target='#globalSearchModal'><i class='fa fa-search'></i> Global Search</a>
            <a style='vertical-align: top;' id='compareButton' class='btn btn-secondary btn-sm' href='/dbc/diff.html'><i class='fa fa-columns'></i> Compare</a>
            <div class="btn-group" style="vertical-align: top">
                <a style='vertical-align: top;' id='updateDefsButton' class='btn btn-danger btn-sm' onclick="updateDefs();" href="#"><i class='fa fa-refresh'></i> Update WoWDBDefs & clear cache</a>
                <a style='vertical-align: top;' id='reloadDefsButton' class='btn btn-danger btn-sm' onclick="reloadDefs();" href="#"><i class='fa fa-refresh'></i> Clear DB2/DBC/DBD cache</a>
            </div>
        </form><br>
        <div id='tableContainer'>
            <br>
            <table id='dbtable' class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                </thead>
                <tbody>
                    <tr>
                        <td style='text-align: center' id='loadingMessage'>Select a table in the dropdown above</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                </div>
                <div class="modal-body" id="settingsModalContent">
                    <input type="checkbox" autocomplete="off" id="tooltipToggle" CHECKED> <label for='tooltipToggle'>
                        Enable
                        tooltips?
                    </label><br>
                    <input type="checkbox" autocomplete="off" id="alwaysEnableFilters" CHECKED> <label for='alwaysEnableFilters'>Always show filters?</label><br>
                    <!--<input type="checkbox" autocomplete="off" id="changedVersionsOnly"> <label for='changedVersionsOnly'>Only show changed versions (experimental)?</label><br>-->
                    <input type="checkbox" autocomplete="off" id="showDBDButton"> <label for='showDBDButton'>
                        Show DBD
                        button?
                    </label><br>
                    <input type="checkbox" autocomplete="off" id="showFKButton"> <label for='showFKButton'>
                        Show FK search
                        button?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings();"
                            data-bs-dismiss="modal">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="fkModal" tabindex="-1" role="dialog" aria-labelledby="fkModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fkModalLabel">Foreign key lookup</h5>
                </div>
                <div class="modal-body" id="fkModalContent">
                    <i class="fa fa-refresh fa-spin" style="font-size:24px"></i>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="moreInfoModal" tabindex="-1" role="dialog" aria-labelledby="moreInfoModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moreInfoModalLabel">More information</h5>
                </div>
                <div class="modal-body" id="moreInfoModalContent">
                    <i class="fa fa-refresh fa-spin" style="font-size:24px"></i>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Preview</h5>
                </div>
                <div class="modal-body" id="previewModalContent">
                    <i class="fa fa-refresh fa-spin" style="font-size:24px"></i>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="chashModal" tabindex="-1" role="dialog" aria-labelledby="chashModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chashModalLabel">Content hash lookup</h5>
                </div>
                <div class="modal-body" id="chashModalContent">
                    <i class="fa fa-refresh fa-spin" style="font-size:24px"></i>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="foreignKeySearchModal" tabindex="-1" role="dialog" aria-labelledby="foreignKeySearchLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="foreignKeySearchLabel">Foreign key search</h5>
                </div>
                <div class="modal-body" id="foreignKeySearchContent">
                    <form class='form-inline' id='foreignKeySearchForm' onsubmit="fkDBSearchSubmit()">
                        <div class="row">
                            <div class="col">
                                <select class='form-control' onchange="fkDBSearchChange()" id="fkSearchDB">
                                    <option>DB Name</option>
                                </select>
                            </div>
                            <div class="col">
                                <select class='form-control' id='fkSearchField' disabled>
                                    <option>Field</option>
                                </select>
                            </div>
                            <div class="col">
                                <input class='form-control' style='height: 26px;' type='text' placeholder='Value'
                                       id='fkSearchValue'>
                            </div>
                            <div class="col">
                                <input class='form-control' type='submit' value='Search'>
                            </div>
                        </div><br>
                    </form>
                    <div id='fkSearchResultHolder'>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="globalSearchModal" tabindex="-1" role="dialog" aria-labelledby=globalSearchLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalSearchLabel">Global search</h5>
                </div>
                <div class="modal-body" id="globalSearchContent">
                    <form class='form-inline' id='globalSearchForm' onsubmit="globalDBSearchSubmit()">
                        <div class="row">
                            <div class="col">
                                <input class='form-control' style='height: 26px;' type='text' placeholder='Value'
                                       id='globalSearchValue'>
                            </div>
                            <div class="col">
                                <input class='form-control' type='submit' value='Search'>
                            </div>
                        </div><br>
                    </form>
                    <div id='globalSearchResultHolder'>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <link href="/css/select2.min.css" rel="stylesheet" />
    <script src="/js/select2.min.js"></script>
    <script src="/js/files.js" crossorigin="anonymous"></script>
    <script src="/js/flags.js"></script>
    <script src="/js/enums.js"></script>
    <script src="/js/dbc.js"></script>
    <script type='text/javascript'>
        var Settings = {
            filtersAlwaysEnabled: false,
            filtersCurrentlyEnabled: false,
            enableTooltips: true,
            showDBDButton: false,
            showFKButton: false,
            lockedBuild: null,
            localBuildName: ""
        };

        (async () => {
            const response = await fetch("/casc/buildname");
            Settings.localBuildName = await response.text();
        })();


        var Locales = {
            enUS: "English (US)",
            koKR: "Korean",
            frFR: "French",
            deDE: "German",
            zhCN: "Simplified Chinese",
            esES: "Spanish",
            zhTW: "Taiwanese Mandarin",
            enGB: "English (GB)",
            esMX: "Mexican Spanish",
            ruRU: "Russian",
            ptBR: "Brazilian Portugese",
            itIT: "Italian",
            ptPT: "Portugese"
        };

        let clearState = false;

        async function reloadDefs() {
            var button = document.getElementById("reloadDefsButton");
            button.innerHTML = "<i class='fa fa-spin fa-refresh'></i> Reloading, please wait!";

            const response = await fetch("/dbc/reloadDefs");
            console.log(await response.text());

            const response2 = await fetch("/dbc/clearCache");
            console.log(await response2.text());

            window.location.reload();
        }

        async function updateDefs() {
            var button = document.getElementById("updateDefsButton");
            button.innerHTML = "<i class='fa fa-spin fa-refresh'></i> Updating, please wait!";

            const response = await fetch("/dbc/updateDefs");
            console.log(await response.text());
            window.location.reload();
        }

        function updateDBDButton() {
            console.log("updating button");
            const dbdButton = document.getElementById("dbdButton");
            if (dbdButton) {
                if (Settings.showDBDButton) {
                    document.getElementById("dbdButton").style.display = 'inline-block';
                } else {
                    document.getElementById("dbdButton").style.display = 'none';
                }

                const fileFilter = document.getElementById("fileFilter");
                if (fileFilter.selectedIndex != -1) {
                    dbdButton.href = "https://github.com/wowdev/WoWDBDefs/blob/master/definitions/" + fileFilter.options[
                        fileFilter.selectedIndex].text + ".dbd";
                    dbdButton.classList.remove("disabled");
                }
            }
        }

        function saveSettings() {
            if (document.getElementById("tooltipToggle").checked) {
                localStorage.setItem('settings[tooltipToggle]', '1');
            } else {
                localStorage.setItem('settings[tooltipToggle]', '0');
            }

            if (document.getElementById("alwaysEnableFilters").checked) {
                localStorage.setItem('settings[alwaysEnableFilters]', '1');
            } else {
                localStorage.setItem('settings[alwaysEnableFilters]', '0');
            }

            //if (document.getElementById("changedVersionsOnly").checked) {
            //    localStorage.setItem('settings[changedVersionsOnly]', '1');
            //} else {
            //    localStorage.setItem('settings[changedVersionsOnly]', '0');
            //}

            if (document.getElementById("showDBDButton").checked) {
                localStorage.setItem('settings[showDBDButton]', '1');
                document.getElementById("dbdButton").style.display = 'inline-block';
            } else {
                localStorage.setItem('settings[showDBDButton]', '0');
                document.getElementById("dbdButton").style.display = 'none';
            }

            if (document.getElementById("showFKButton").checked) {
                localStorage.setItem('settings[showFKButton]', '1');
                document.getElementById("fkSearchButton").style.display = 'inline-block';
            } else {
                localStorage.setItem('settings[showFKButton]', '0');
                document.getElementById("fkSearchButton").style.display = 'none';
            }

            if (document.getElementById("lockedBuild").value == null || document.getElementById("lockedBuild").value ==
                "none") {
                localStorage.removeItem('settings[lockedBuild]');
            } else {
                localStorage.setItem('settings[lockedBuild]', document.getElementById("lockedBuild").value);
            }

            //if (Settings.changedVersionsOnly != document.getElementById("changedVersionsOnly").checked) {
            //    loadSettings();
            //    //refreshVersions();
            //}

            //if (Settings.lockedBuild != localStorage.getItem('settings[lockedBuild]')) {
            //    loadSettings();
            //    refreshFiles();
            //    //refreshVersions();
            //    loadTable();
            //}
        }

        function loadSettings() {
            /* Enable tooltips? */
            var tooltipToggle = localStorage.getItem('settings[tooltipToggle]');
            if (tooltipToggle) {
                if (tooltipToggle == "1") {
                    Settings.enableTooltips = true;
                } else {
                    Settings.enableTooltips = false;
                }
            }

            document.getElementById("tooltipToggle").checked = Settings.enableTooltips;

            /* Filters always enabled? */
            var alwaysEnableFilters = localStorage.getItem('settings[alwaysEnableFilters]');
            if (alwaysEnableFilters) {
                if (alwaysEnableFilters == "1") {
                    Settings.filtersAlwaysEnabled = true;
                } else {
                    Settings.filtersAlwaysEnabled = false;
                }
            }

            document.getElementById("alwaysEnableFilters").checked = Settings.filtersAlwaysEnabled;

            /* Changed versions only? */
            //var changedVersionsOnly = localStorage.getItem('settings[changedVersionsOnly]');
            //if (changedVersionsOnly) {
            //    if (changedVersionsOnly == "1") {
            //        Settings.changedVersionsOnly = true;
            //    } else {
            //        Settings.changedVersionsOnly = false;
            //    }
            //}

            //document.getElementById("changedVersionsOnly").checked = Settings.changedVersionsOnly;

            /* Show DBD button? */
            var showDBDButton = localStorage.getItem('settings[showDBDButton]');
            if (showDBDButton) {
                if (showDBDButton == "1") {
                    Settings.showDBDButton = true;
                    document.getElementById("dbdButton").style.display = 'inline-block';
                } else {
                    Settings.showDBDButton = false;
                    document.getElementById("dbdButton").style.display = 'none';
                }
            }

            document.getElementById("showDBDButton").checked = Settings.showDBDButton;

            /* Show FK button? */
            var showFKButton = localStorage.getItem('settings[showFKButton]');
            if (showFKButton) {
                if (showFKButton == "1") {
                    Settings.showFKButton = true;
                    document.getElementById("fkSearchButton").style.display = 'inline-block';
                } else {
                    Settings.showFKButton = false;
                    document.getElementById("fkSearchButton").style.display = 'none';
                }
            }

            document.getElementById("showFKButton").checked = Settings.showFKButton;

            var lockedBuild = localStorage.getItem("settings[lockedBuild]");
            Settings.lockedBuild = lockedBuild;

            if (lockedBuild && lockedBuild != "none") {
                document.getElementById("lockedBuild").value = lockedBuild;
            }
        }

        loadSettings();

        function updateCompareButtonHref() {
            // Script to dynamically set the href of the compare button based on the currently selected dbc
            let dbc = currentParams["dbc"];
            if (dbc == "")
                return;
            let button = document.getElementById("compareButton");
            button.href = "/dbc/diff.html?dbc=" + dbc;
        }

        function toggleFilters() {
            if (!Settings.filtersCurrentlyEnabled) {
                $("#filterToggle").text("Disable filters");
                $("#filterToggle").addClass("btn-outline-danger");
                $("#filterToggle").removeClass("btn-outline-success");
                $("#filterToggle").removeClass("btn-outline-primary");
                $("#tableContainer thead tr").clone(true).appendTo("#tableContainer thead");
                $("#tableContainer thead tr:eq(1) th").each(function (i) {
                    var title = $(this).text();

                    $(this).html('<input type="text"/>');

                    if ($('#dbtable').DataTable().column(i).search() != "") {
                        $('input', this).val($('#dbtable').DataTable().column(i).search());
                    }

                    $('input', this).on('keyup change', function () {
                        if ($('#dbtable').DataTable().column(i).search() !== this.value) {
                            $('#dbtable').DataTable().column(i).search(this.value).draw();
                        }
                    });

                    $('input', this).on('click', function (e) {
                        e.stopPropagation();
                    });
                });

                Settings.filtersCurrentlyEnabled = true;
            } else {
                $("#filterToggle").text("Enable filters");
                $("#filterToggle").addClass("btn-outline-success");
                $("#filterToggle").removeClass("btn-outline-danger");
                $("#filterToggle").removeClass("btn-outline-primary");

                $("#tableContainer thead tr:eq(1) th").each(function (i) {
                    $('#dbtable').DataTable().column(i).search("");
                });

                $("#tableContainer thead tr:eq(1)").remove();

                Settings.filtersCurrentlyEnabled = false;
            }

            $('#dbtable').DataTable().draw('page');
        }

        function buildURL(currentParams) {
            let url = "/dbc/";

            if (currentParams["dbc"]) {
                url += "?dbc=" + currentParams["dbc"];
            }

            if (currentParams["build"]) {
                url += "&build=" + currentParams["build"];
            }

            if (currentParams["locale"]) {
                url += "&locale=" + currentParams["locale"];
            }

            if (currentParams["hotfixes"]) {
                url += "&hotfixes=" + currentParams["hotfixes"];
            }

            return url;
        }

        function refreshFiles() {
            console.log("Refreshing files");

            let apiURL = "/listfile/db2s";

            fetch(apiURL)
                .then(function (fileResponse) {
                    return fileResponse.json();
                }).then(function (data) {
                    var fileFilter = document.getElementById('fileFilter');
                    fileFilter.innerHTML = "";

                    var option = document.createElement("option");
                    option.text = "Select a table";
                    fileFilter.appendChild(option);

                    data.forEach((file) => {
                        var option = document.createElement("option");
                        option.value = file;
                        option.text = file;
                        if (option.value.toLowerCase() == currentParams["dbc"]) {
                            option.selected = true;
                        }
                        fileFilter.appendChild(option);
                    });

                    updateDBDButton();
                }).catch(function (error) {
                    console.log("An error occurred retrieving files: " + error);
                });
        }

        function refreshVersions() {
            if (currentParams["dbc"] == "")
                return;

            var currentDBC = currentParams["dbc"];

            console.log("Refreshing versions");
            var versionAPIURL = "/listfile/db2/" + currentParams["dbc"] + "/versions";
            if (Settings.changedVersionsOnly)
                versionAPIURL += "?uniqueOnly=true";

            document.getElementById("buildFilter").disabled = true;
            document.getElementById("buildFilter").classList.add('disabled');

            fetch(versionAPIURL)
                .then(function (versionResponse) {
                    return versionResponse.json();
                }).then(function (data) {
                    if (currentDBC != currentParams["dbc"]) {
                        console.log("DBC has changed from " + currentDBC + " to " + currentParams["dbc"] + " since versions were requested, discarding..");
                        return;
                    }

                    var buildFilter = document.getElementById('buildFilter');
                    buildFilter.innerHTML = "";

                    var validBuilds = [];

                    var preselected = false;
                    if (Settings.lockedBuild != null && Settings.lockedBuild != "none" && (!data.includes(Settings
                        .lockedBuild))) {
                        console.log("Locked build is not in dropdown");

                        var option = document.createElement("option");
                        option.value = Settings.lockedBuild;
                        option.text = Settings.lockedBuild;
                        option.selected = true;
                        preselected = true;
                        buildFilter.appendChild(option);
                    }

                    data.forEach((version) => {
                        var option = document.createElement("option");
                        option.value = version.item1;
                        option.text = version.item1 + " (" + version.item2 + ")";
                        validBuilds.push(version.item1);

                        if (!preselected && (option.value == currentParams["build"])) {
                            option.selected = true;
                        }

                        buildFilter.appendChild(option);
                    });

                    if (currentParams["build"] == "" || !validBuilds.includes(currentParams["build"])) {
                        // No build was selected, load table with the latest build
                        console.log("No or invalid build selected, loading table with latest build");
                        if (Settings.lockedBuild !== null) {
                            currentParams["build"] = Settings.lockedBuild;
                        } else {
                            currentParams["build"] = data[0].item1;
                        }

                        loadTable();
                    }

                    //if (Settings.lockedBuild != null && Settings.lockedBuild != "none") {
                    //    buildFilter.disabled = true;
                    //    buildFilter.classList.add("disabled");
                    //    buildFilter.title = "Build locked in settings";
                    //} else {
                        buildFilter.disabled = false;
                        buildFilter.classList.remove("disabled");
                        buildFilter.title = "";
                    //}

                }).catch(function (error) {
                    console.log("An error occurred retrieving versions: " + error);
                });
        }

        function fkDBSearchChange() {
            // Load headers and fill columns options
            const currentDBC = document.getElementById("fkSearchDB").value;

            fetch("/dbc/header/" + currentDBC + "/?build=" + currentParams["build"]).then(function (headerResponse) {
                return headerResponse.json();
            }).then(function (json) {
                var fkSearchField = document.getElementById('fkSearchField');
                fkSearchField.disabled = false;
                fkSearchField.innerHTML = "";

                json.headers.forEach((header) => {
                    if (header in json.relationsToColumns) {
                        var option = document.createElement("option");
                        option.value = header;
                        option.text = header;
                        console.log(header);
                        fkSearchField.appendChild(option);
                    }
                });

                $('#fkSearchField').select2({ theme: 'bootstrap-5' });
            });
        }

        function globalDBSearchSubmit() {
            event.preventDefault();

            const searchValue = document.getElementById("globalSearchValue").value;

            globalDBSearch(searchValue, false);
        }
        function fkDBSearchSubmit() {
            event.preventDefault();

            const currentDBC = document.getElementById("fkSearchDB").value;
            const currentField = document.getElementById("fkSearchField").value;
            const searchValue = document.getElementById("fkSearchValue").value;

            fkDBSearch(currentDBC, currentField, searchValue, false);
        }

        async function globalDBSearch(val, isInline = false) {
            if (!isInline) {
                document.getElementById("globalSearchForm").style.display = "none";
            } else {
                document.getElementById("globalSearchForm").style.display = "flex";
            }

            document.getElementById("globalSearchResultHolder").innerHTML =
                "<ul class='nav nav-tabs' id='globalresultTabList' role='tablist'></ul><div class='tab-content' id='globalresultTabs'></div><div id='noGlobalResultHolder'></div>";

            const dbsToSearch = [];

            var select = document.getElementById("fileFilter");
            for (var i = 0; i < select.length; i++) {
                const option = select.options[i];
                if (option.value == "Select a table") {
                    continue;
                }

                dbsToSearch.push(async () => {
                    try {
                        const result = await fetch("/dbc/find/?name=" + option.value + "&build=" +
                            currentParams["build"] + "&value=" + val);
                        const json = await result.json();
                        globalDBResults(option.value, json, val);
                    } catch (e) {
                        console.log(e);
                    }
                });
            }

            dbsToSearch.forEach(anonPromise => anonPromise());

            await Promise.all(dbsToSearch);
        }

        async function fkDBSearch(db, col, val, isInline = false) {
            if (!isInline) {
                document.getElementById("foreignKeySearchForm").style.display = "none";
            } else {
                document.getElementById("foreignKeySearchForm").style.display = "flex";
            }

            document.getElementById("fkSearchResultHolder").innerHTML =
                "<ul class='nav nav-tabs' id='fkresultTabList' role='tablist'></ul><div class='tab-content' id='fkresultTabs'></div><div id='noResultHolder'></div>";

            const dbsToSearch = [];
            const headerResult = await fetch("/dbc/header/" + db + "/?build=" + currentParams["build"]);
            const headerJSON = await headerResult.json();

            headerJSON.relationsToColumns[col].forEach((foreignKey) => {
                const splitFK = foreignKey.split("::");
                dbsToSearch.push(async () => {
                    try {
                        const result = await fetch("/dbc/find/" + splitFK[0] + "?build=" +
                            currentParams["build"] + "&col=" + splitFK[1] + "&val=" + val);
                        const json = await result.json();
                        fkDBResults(splitFK, json, val);
                    } catch (e) {
                        console.log(e);
                    }
                });
            });

            dbsToSearch.forEach(anonPromise => anonPromise());

            await Promise.all(dbsToSearch);
        }

        function fkDBResults(splitFK, results, searchVal) {
            console.log("Search results for " + splitFK, results);

            const tabHolder = document.getElementById("fkresultTabList");
            const resultHolder = document.getElementById("fkresultTabs");
            const fkNoResultHolder = document.getElementById("fkresultTabs");

            if (results.length) {
                if (tabHolder.children.length == 0) {
                    tabHolder.innerHTML += "<li class='nav-item'><a class='nav-link active' data-bs-toggle='tab' href='#tab" +
                        splitFK[0] + splitFK[1] + "'>" + splitFK[0] + "::" + splitFK[1] + "</a></li>";
                } else {
                    tabHolder.innerHTML += "<li class='nav-item'><a class='nav-link' data-bs-toggle='tab' href='#tab" + splitFK[
                        0] + splitFK[1] + "'>" + splitFK[0] + "::" + splitFK[1] + "</a></li>";
                }

                let resultsHTML = "";
                if (resultHolder.children.length == 0) {
                    resultsHTML += "<div class='tab-pane show active' id='tab" + splitFK[0] + splitFK[1] + "'>";
                } else {
                    resultsHTML += "<div class='tab-pane' id='tab" + splitFK[0] + splitFK[1] + "'>";
                }

                if (results.length < 1000) {
                    resultsHTML += "<br><table id='FKResults" + splitFK[0] + splitFK[1] + "' class='table table-sm'>";
                    resultsHTML += "<thead><tr>";
                    let targetCol = 0;
                    Object.keys(results[0]).forEach((key) => {
                        if (key == splitFK[1]) {
                            targetCol = Object.keys(results[0]).indexOf(key);
                            resultsHTML += "<th class='text-success'>" + key + "</th>";
                        } else {
                            resultsHTML += "<th>" + key + "</th>";
                        }
                    });

                    resultsHTML += "</tr></thead><tbody></tbody>";
                    var externalResultURL = "/dbc/?dbc=" + splitFK[0].toLowerCase() + "&build=" + currentParams["build"] + "#page=1&colFilter[" + targetCol + "]=exact:" + encodeURIComponent(searchVal);
                    resultsHTML += "</table><br><a class='btn btn-sm btn-primary' href='" + externalResultURL + "' target='_BLANK'>View " + splitFK[0] + "::" + splitFK[1] + " results in new tab</a></div>";
                    resultHolder.insertAdjacentHTML('beforeend', resultsHTML);
                    const dt = $("#FKResults" + splitFK[0] + splitFK[1]).DataTable({
                        "searching": false,
                        "pageLength": 10,
                        "displayStart": 0,
                        "autoWidth": true
                    });

                    results.forEach((result) => {
                        dt.rows.add([Object.values(result)]);
                    });

                    dt.draw();
                } else {
                    let targetCol = 0;
                    Object.keys(results[0]).forEach((key) => {
                        if (key == splitFK[1]) {
                            targetCol = Object.keys(results[0]).indexOf(key);
                        }
                    });
                    var externalResultURL = "/dbc/?dbc=" + splitFK[0].toLowerCase() + "&build=" + currentParams["build"] + "#page=1&colFilter[" + targetCol + "]=exact:" + encodeURIComponent(searchVal);
                    resultsHTML += "<a class='btn btn-sm btn-primary' href='" + externalResultURL + "' target='_BLANK'>Too many results! View " + splitFK[0] + "::" + splitFK[1] + " results in new tab</a></div>";

                    resultHolder.insertAdjacentHTML('beforeend', resultsHTML);
                }
            } else {
                if (document.getElementById("noResultHolder").innerHTML == "") {
                    document.getElementById("noResultHolder").innerHTML = "<b>No results for: </b>";
                }

                document.getElementById("noResultHolder").innerHTML += splitFK[0] + "::" + splitFK[1] + ", ";
            }
        }

        function globalDBResults(name, results, searchVal) {
            const tabHolder = document.getElementById("globalresultTabList");
            const resultHolder = document.getElementById("globalresultTabs");
            const globalNoResultHolder = document.getElementById("noGlobalResultHolder");

            if (results.length) {
                if (tabHolder.children.length == 0) {
                    tabHolder.innerHTML += "<li class='nav-item'><a class='nav-link active' data-bs-toggle='tab' href='#tab" +
                        name + "'>" + name + "</a></li>";
                } else {
                    tabHolder.innerHTML += "<li class='nav-item'><a class='nav-link' data-bs-toggle='tab' href='#tab" + name + "'>" + name + "</a></li>";
                }

                let resultsHTML = "";
                if (resultHolder.children.length == 0) {
                    resultsHTML += "<div class='tab-pane show active' id='tab" + name + "'>";
                } else {
                    resultsHTML += "<div class='tab-pane' id='tab" + name + "'>";
                }

                if (results.length < 1000) {
                    resultsHTML += "<br><table id='globalResults" + name + "' class='table table-sm'>";
                    resultsHTML += "<thead><tr>";
                    Object.keys(results[0]).forEach((key) => {
                        resultsHTML += "<th>" + key + "</th>";
                    });
                    resultsHTML += "</tr></thead><tbody></tbody>";
                    var externalResultURL = "/dbc/?dbc=" + name + "&build=" + currentParams["build"] + "#page=1&search=" + encodeURIComponent(searchVal);
                    resultsHTML += "</table><br><a class='btn btn-sm btn-primary' href='" + externalResultURL + "' target='_BLANK'>View " + name + " results in new tab</a></div>";
                    resultHolder.insertAdjacentHTML('beforeend', resultsHTML);
                    const dt = $("#globalResults" + name).DataTable({
                        "searching": false,
                        "pageLength": 10,
                        "displayStart": 0,
                        "autoWidth": true
                    });

                    results.forEach((result) => {
                        dt.rows.add([Object.values(result)]);
                    });

                    dt.draw();
                } else {
                    var externalResultURL = "/dbc/?dbc=" + name + "&build=" + currentParams["build"] + "#page=1&search=" + encodeURIComponent(searchVal);
                    resultsHTML += "<a class='btn btn-sm btn-primary' href='" + externalResultURL + "' target='_BLANK'>Too many results! View " + name + " results in new tab</a></div>";

                    resultHolder.insertAdjacentHTML('beforeend', resultsHTML);
                }
            } else {
                if (globalNoResultHolder.innerHTML == "") {
                    globalNoResultHolder.innerHTML = "<b>No results for: </b>";
                }

                globalNoResultHolder.innerHTML += name + ", ";
            }
        }

        function loadTable() {
            if (!currentParams["dbc"] || !currentParams["build"]) {
                // Don't bother doing anything else if no DBC is selected
                console.log("No DBC or build selected, skipping table load.");
                return;
            }
            Settings.filtersCurrentlyEnabled = false;

            build = currentParams["build"];
            locale = currentParams["locale"];

            $("#dbtable").html(
                "<tbody><tr><td style='text-align: center' id='loadingMessage'>Select a table in the dropdown above</td></tr></tbody>"
            );
            document.getElementById('downloadCSVButton').href = buildURL(currentParams).replace("/dbc/?dbc=", "/dbc/export/?name=");
            document.getElementById('downloadallCSVLink').href = "/dbc/export/all/?build=" + build + "&locale=" + locale;
            document.getElementById('downloadDB2Link').href = "/dbc/export/db2/?tableName=" + currentParams["dbc"] + "&fullBuild=" + build + "&locale=" + locale;

            document.getElementById('downloadCSVButton').classList.remove("disabled");
            $("#loadingMessage").html("Loading..");

            let apiArgs = currentParams["dbc"] + "/?build=" + currentParams["build"];

            if (currentParams["locale"] != "") {
                apiArgs += "&locale=" + currentParams["locale"];
            }

            if (currentParams["hotfixes"]) {
                apiArgs += "&useHotfixes=true";
                document.getElementById('downloadCSVButton').href = document.getElementById('downloadCSVButton').href.replace("&hotfixes=", "&useHotfixes=");
            }

            /*
            const buildSplit = currentParams["build"].split('.');
            const buildOnly = buildSplit[buildSplit.length - 1];

            let hotfixedIDs = [];

            if (currentParams["hotfixes"]) {
                fetch(APIBase + "databases/" + currentParams["dbc"] + "/hotfixes?build=" + buildOnly)
                    .then(function (response) {
                        return response.json();
                    }).then(function (data) {
                        hotfixedIDs = data;
                    });
            }
            */

            updateCompareButtonHref() // update the compare button link

            const tableContainer = document.getElementById("tableContainer");
            const loadingMessage = document.getElementById("loadingMessage");
            let tableHeaders = "";
            let idHeader = 0;

            fetch("/dbc/header/" + currentParams["dbc"] + "/?build=" + currentParams["build"])
                .then(function (response) {
                    return response.json();
                }).then(function (json) {
                    if (json['error'] != "") {
                        if (json['error'] == "No valid definition found for this layouthash or build!") {
                            json['error'] += "\n\nPlease open an issue on the WoWDBDefs repository with the DBC name and selected version on GitHub to request a definition for this build.\n\nhttps://github.com/wowdev/WoWDBDefs";
                        }
                        loadingMessage.innerHTML = "<div class='alert '><b>Whoops, something exploded while loading this DBC</b><br>If you feel this is not intended, please report the below error (together with the table name and version).</p><p style='margin: 5px;'><kbd>" + json['error'] + "</kbd></p></div>";
                        return;
                    }

                    const allCols = [];

                    for (let i = 0; i < json['headers'].length; i++) {
                        const colName = json['headers'][i];
                        tableHeaders += "<th style='white-space: nowrap' ";
                        if (colName in json['comments']) {
                            tableHeaders += "title='" + json['comments'][colName] + "' class='colHasComment'>";
                        } else {
                            tableHeaders += ">";
                        }

                        if (colName in json['relationsToColumns']) {
                            tableHeaders +=
                                " <i class='fa fa-reply' style='font-size: 10px' title='The following tables point to this column: " +
                            json['relationsToColumns'][colName].join(", ") + "'></i> ";
                        }

                        tableHeaders += colName;

                        if (colName.startsWith("Field_")) {
                            tableHeaders +=
                                " <i class='fa fa-question' style='color: red; font-size: 12px' title='This column is not yet named'></i> ";
                        } else if (json['unverifieds'].includes(colName)) {
                            tableHeaders +=
                                " <i class='fa fa-question' style='font-size: 12px' title='This column name is not verified to be 100% accurate'></i> ";
                        }

                        if (colName in json['fks']) {
                            tableHeaders +=
                                " <i class='fa fa-share' style='font-size: 10px' title='This column points to " +
                            json['fks'][colName] + "'></i> ";
                        }

                        tableHeaders += "</th>";

                        if (colName == "ID") {
                            idHeader = i;
                        }
                        allCols.push(i);
                    }

                    const fkCols = getFKCols(json['headers'], json['fks']);
                    tableContainer.innerHTML = '<table id="dbtable" class="table table-striped table-bordered" cellspacing="0" width="100%"><thead><tr>' + tableHeaders + '</tr></thead></table>';

                    let searchHash = location.hash.substr(1),
                        searchString = searchHash.substr(searchHash.indexOf('search=')).split('&')[0].split('=')[1];

                    if (searchString != undefined && searchString.length > 0) {
                        searchString = decodeURIComponent(searchString);
                    }

                    let page = (parseInt(searchHash.substr(searchHash.indexOf('page=')).split('&')[0].split('=')[1],10) || 1) - 1;
                    let highlightRow = parseInt(searchHash.substr(searchHash.indexOf('row=')).split('&')[0].split('=')[1], 10) - 1;
                    $.fn.dataTable.ext.errMode = 'none';

                    $('#dbtable').on('error.dt', function (e, settings, techNote, message) {
                        console.log('An error occurred: ', message);
                    });

                    var colSearchSet = false;
                    var colSearches = [];

                    if (!clearState) {
                        for (let i = 0; i < json['headers'].length; i++) {
                            var colSearch = searchHash.substr(searchHash.replace("%5B", "[").replace("%5D", "]").indexOf('colFilter[' + i + ']=')).split(
                                '&')[0].split('=')[1];
                            if (colSearch != undefined && colSearch != "") {
                                colSearches.push({
                                    search: decodeURIComponent(colSearch.trim())
                                });
                                colSearchSet = true;
                            } else {
                                colSearches.push(null);
                            }
                        }
                    } else {
                        console.log("Clearing state");
                        page = 0;
                        clearState = false;
                    }

                    var table = $('#dbtable').DataTable({
                        "processing": true,
                        "serverSide": true,
                        "ajax": {
                            url: "/dbc/data/" + apiArgs,
                            type: "POST",
                            beforeSend: function () {
                                if (table && table.hasOwnProperty('settings')) {
                                    // table.settings()[0].jqXHR.abort();
                                }
                            },
                            "data": function (result) {
                                for (const col in result.columns) {
                                    result.columns[col].search.value = result.columns[col].search.value
                                        .trim();
                                }
                                return result;
                            }
                        },
                        "pageLength": 25,
                        "displayStart": page * 25,
                        "autoWidth": true,
                        "lengthMenu": [
                            [10, 25, 50, 100, 1000],
                            [10, 25, 50, 100, 1000]
                        ],
                        "orderMulti": false,
                        layout: {
                            bottomEnd: 'inputPaging'
                        },
                        "ordering": true,
                        "order": [], // Sets default order to nothing (as returned by backend)
                        "language": {
                            "search": "<a id='filterToggle' class='btn btn-dark btn-sm btn-outline-primary' href='#' onClick='toggleFilters()' style='margin-right: 10px'>Toggle filters</a> Search: _INPUT_ "
                        },
                        "search": {
                            "search": searchString
                        },
                        "searchCols": colSearches,
                        "columnDefs": [{
                            "targets": allCols,
                            "render": function (data, type, full, meta) {
                                return columnRender(full, json.headers[meta.col], data, currentParams["dbc"], currentParams["build"], json, fkCols, null, conditionalFKs);
                            }
                        }],
                        "createdRow": function (row, data, dataIndex) {
                            if (dataIndex == highlightRow) {
                                $(row).addClass('highlight');
                                highlightRow = -1;
                            }
                        },
                    });

                    $('#dbtable').on('init.dt', function () {
                        if (Settings.filtersAlwaysEnabled) {
                            toggleFilters();
                        }
                        if (colSearchSet && !Settings.filtersAlwaysEnabled && !Settings.filtersCurrentlyEnabled) {
                            toggleFilters();
                        }
                    });

                    $('#dbtable').on('draw.dt', function () {
                        window.history.pushState('dbc', 'WoW.Tools | Database browser', buildURL(currentParams));

                        let currentPage = $('#dbtable').DataTable().page() + 1;
                        let hashPart = "page=" + currentPage;

                        const currentSearch = encodeURIComponent($("#dt-search-0").val());
                        if (currentSearch != "" && currentSearch != undefined && currentSearch != "undefined") {
                            hashPart += "&search=" + currentSearch;
                        }

                        const columnSearches = $('#dbtable').DataTable().columns().search();
                        for (let i = 0; i < columnSearches.length; i++) {
                            var colSearch = columnSearches[i];

                            if (colSearch == "")
                                continue;

                            hashPart += "&colFilter[" + i + "]=" + encodeURIComponent(colSearch);
                        }

                        window.location.hash = hashPart;
                    });
                });
        }

        let build;
        let currentParams = [];

        (async function () {
            $('#fileFilter').select2({ theme: 'bootstrap-5' });
            $('#lockedBuild').select2({ theme: 'bootstrap-5' });
            let vars = {};
            let parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
                if (value.includes('#')) {
                    const splitString = value.split('#');
                    vars[key] = splitString[0];
                } else {
                    vars[key] = value;
                }
            });

            if (vars["dbc"] == null) {
                currentParams["dbc"] = "";
            } else {
                currentParams["dbc"] = vars["dbc"].replace(".db2", "").toLowerCase().split('#')[0];
            }

            if (!currentParams.includes("build") || currentParams["build"] == "") {
                if ("build" in vars) {
                    currentParams["build"] = vars["build"];
                } else {
                    const response = await fetch("/casc/buildname");
                    const build = await response.text();
                    currentParams["build"] = build;
                }
            }

             if (vars["locale"] == null) {
                 currentParams["locale"] = "enUS";
             } else {
                 currentParams["locale"] = vars["locale"];
             }

             const localeSelection = document.getElementById("localeSelection");

             for (let value of Object.entries(Locales)) {
                 var option = document.createElement("option");
                 option.val = value[1];
                 option.text = value[0];

                 if(currentParams["locale"] == value[0]){
                     option.selected = true;
                 }

                 localeSelection.appendChild(option);
             }

            currentParams["hotfixes"] = false;
            if (vars["hotfixes"] == "true") {
                currentParams["hotfixes"] = true;
                document.getElementById('hotfixToggle').checked = true;
            } else {
                document.getElementById('hotfixToggle').checked = false;
            }

            refreshFiles();
            refreshVersions();
            loadTable();

            $('#fileFilter').on('change', function () {
                if ($(this).val() != "" && $(this).val() != "Select a table") {
                    currentParams["dbc"] = $(this).val().toLowerCase();
                    if (document.getElementById("buildFilter")) {
                        clearState = true;
                        refreshVersions();
                        loadTable();
                        updateDBDButton();
                    } else {
                        document.location = buildURL(currentParams);
                    }
                }
            });

            $('#buildFilter').on('change', function () {
                currentParams["build"] = $('#buildFilter').val();
                loadTable();
            });

             $('#localeSelection').on('change', function() {
                 currentParams["locale"] = $('#localeSelection').val();
                 loadTable();
             });

            $('#hotfixToggle').on('change', function () {
                if (document.getElementById('hotfixToggle').checked) {
                    currentParams["hotfixes"] = true;
                } else {
                    currentParams["hotfixes"] = false;
                }
                loadTable();
            });

            console.log("Refreshing files");

            /* FK search */
            var fkSearchDB = document.getElementById('fkSearchDB');
            fetch("/dbc/relations/")
                .then(function (fileResponse) {
                    return fileResponse.json();
                }).then(function (data) {
                    const dbsWithRelations = [];

                    Object.keys(data).sort().forEach((fk) => {
                        const splitFK = fk.split("::");
                        if (!dbsWithRelations.includes(splitFK[0])) {
                            dbsWithRelations.push(splitFK[0]);
                        }
                    });

                    fkSearchDB.innerHTML = "";

                    var option = document.createElement("option");
                    option.text = "Select a table";
                    fkSearchDB.appendChild(option);

                    dbsWithRelations.forEach((file) => {
                        var option = document.createElement("option");
                        option.value = file.toLowerCase();
                        option.text = file;
                        fkSearchDB.appendChild(option);
                    });

                    $('#fkSearchDB').select2({ theme: 'bootstrap-5' });
                }).catch(function (error) {
                    console.log("An error occurred retrieving files: " + error);
                });
            $('#foreignKeySearchModal').on('hidden.bs.modal', function () {
                document.getElementById("foreignKeySearchForm").style.display = 'flex';
                document.getElementById("fkSearchResultHolder").innerHTML = "";
            })
        }());
    </script>
</body>
</html>